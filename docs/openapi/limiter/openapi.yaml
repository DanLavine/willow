openapi: "3.0.0"

info:
  description: Limiter API
  title: Limiter
  version: poc 0.0.1

# Get rid of the 'query' api and have everything just be a 'match' api to browse like how the counters would use the service?
# But then how do I list things as a user. To 'Query' the Rules, I need to check the 'GroupBy', but even then it is special
# as I am only looking to see if a key exists. In the GroupBy case, we don't care about the values at all... I think as a
# poc that is fine. Can kick the can down the road for what it means to actualy 'Query' the limiter service Rules/Overrides
# in the same way one would query the Counters.
#
# Currently I'm thinking a 'Query' for the rules needs another use case where I am grouping arbitrary KeyValues together.
# As it stands, its a special workflow for the Limiter service and being a 1 off. I'm going to strip all the special features
# for this POC

paths:
  /v1/limiter/rules:
    post:
      operationId: create Rule
      description: |
        `Rules` are the definied restrictive resource for the `Counters` API. Each `Rule` that matches against the `Counter.KeyValues`
        request is evaluated to ensure that the specific `Rule's` GroupBy selection has not hit the provided limit. It is importnat to
        note that if multiple `Rules` all match the same `Counter.KeyValues` then each `Rule` will be evaluated unless one fails which stops the processing

        There is special logic when a Rule has a Limit = 0. In this case the service will respond quickly rejecting the request saying the limit has been reached
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              $ref: "#/components/schemas/RuleRequest"
      responses:
        201:
          description: Created the `Rule`
        400:
          description: Error parsing or validating the request body
          content:
            appplication/json:
              schema:
                $ref: "../common/components.yaml#/components/schemas/ApiError"
        422:
          description: Conflict if another rule already exists with the same Name or GroupBy keys
          content:
            appplication/json:
              schema:
                $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
    get:
      description: |
        List any Rules that match the particular `KeyValues` and their `Overrides`
      operationId: list Rules
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              $ref: "#/components/schemas/RuleMatch"
      responses:
        200:
          description: Successfully searched for any rules that matched the query
          content:
            appplication/json:
              schema:
                $ref: "#/components/schemas/ListRulesResponse"
        400:
          description: Error parsing or validating the request
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
  /v1/limiter/rules/:rule_name:
    get:
      operationId: get Rule
      description: |
        Get the `Rule` by name and possible `Overrides`
      parameters:
        - in: header
          name: Content-Type
          schema:
            type: string
            enum: ["application/json"]
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              type: object
              properties:
                MatchOverrides:
                  $ref: "../common/components.yaml#/components/schemas/MatchKeyValues"
                QueryOverrides:
                  $ref: "../common/components.yaml#/components/schemas/AssociatedKeyValuesQuery"
      responses:
        200:
          description: |
            Retrieved a single Rule's specification
          content:
            appplication/json:
              schema:
                $ref: "#/components/schemas/RuleResponse"
        400:
          description: Error parsing or validating the request parameters
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        422:
          description: The `Rule` could not be found
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
    put:
      operationId: update Rule
      description: |
        update a specific `Rule`.
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              $ref: "#/components/schemas/UpdateRuleRequest"
      responses:
        200:
          description: Successfully updated the `Rule`
        400:
          description: Error parsing or validating the request body
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        422:
          description: The original `Rule` could not be found
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
    delete:
      operationId: delete Rule
      description: |
        Delete a specific `Rule` and any `Overrides` associated with the rule
      responses:
        204:
          description: Successfully deleted the `Rule` and all associatted `Overrides`
        500:
          description: Unexpected error service side
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
  /v1/limiter/rules/:rule_name/overrides:
    post:
      operationId: create Rule Override
      description: |
        Create a new `Override` for a set of `KeyValues`. If multiple `Overrides` have the exact same Name
        or `KeyValues`, then an API error will be returned.

        When matching a `Counter.KeyValues` and there are multiple `Overrides` that match, then each `Override`
        will be checked to ensure no limits are reached.
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              $ref: "#/components/schemas/RuleOverride"
      responses:
        201:
          description: Created a new `Override` for a given `Rule`
        400:
          description: Error parsing or validating the request body
          content:
            appplication/json:
              schema:
                $ref: "../common/components.yaml#/components/schemas/ApiError"
        404:
          description: returned if the `Rule` name cannot be found
          content:
            appplication/json:
              schema:
                $ref: "../common/components.yaml#/components/schemas/ApiError"
        422:
          description: Conflict if another `Override` already exists with the same KeyValues or Name
          content:
            appplication/json:
              schema:
                $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
    get:
      description: |
        List any Override that match the particular `KeyValues`
      operationId: match Overrides
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              $ref: "../common/components.yaml#/components/schemas/MatchKeyValues"
      responses:
        200:
          description: Successfully searched for any rules that matched the query
          content:
            appplication/json:
              schema:
                $ref: "#/components/schemas/ListRulesResponse"
        400:
          description: Error parsing or validating the request
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
  /v1/limiter/rules/:rule_name/overrides/:override_name:
    get:
      operationId: get Override
      responses:
        200:
          description: Successfully found the desired `Override` for a `Rule`
          content:
            appplication/json:
              schema:
                $ref: "#/components/schemas/RuleOverride"
        400:
          description: Error parsing or validating the request
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        422:
          description: The `Rule` or `Override` could not be found
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
    put:
      operationId: update Override
      description: |
        update a specific `Override`.
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              $ref: "#/components/schemas/UpdateOverrideRequest"
      responses:
        200:
          description: Successfully updated the `Override`
        400:
          description: Error parsing or validating the request body
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        409:
          description: "`Override` Name or KeyValues are already taken"
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"

        422:
          description: The `Rule` or `Override` could not be found
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
    delete:
      operationId: delete Rule Override
      responses:
        204:
          description: deleted the Rule Override
        422:
          description: Conflict if the `Rule` or `Override` do not exist
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
  /v1/limiter/counters:
    put:
      operationId: create or update Counters
      description: |
        Create or Update a `Counter` which is a collection of `KeyValues`. If the `Counters` is positive, then the counters
        will be incremented and all `Rules` are matched to ensure that they have not reached a limit for the `KeyValues`.
        If that has happened, then the request will fail and it is up to the client to eventually retry the request.

        If the `Countres` is negative, then the counters will be decremented. If the total counters is less than or equal
        to 0 after the applied changes, the `Counter` is removed from the service
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              $ref: "#/components/schemas/Counter"
      responses:
        200:
          description: Incremented the counter for the group of `KeyValues`
        400:
          description: Error parsing or validating the request body
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        409:
          description: Conflict if a particular `Rule's` limits are already reached
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "#/components/schemas/LimitReachedResponse"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
    get:
      operationId: query Counters
      description: |
        Find any number of `Counters` that match the provided query.
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              $ref: "../common/components.yaml#/components/schemas/AssociatedKeyValuesQuery"
      responses:
        200:
          description: List of all counters that match the query
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "#/components/schemas/Counters"
        400:
          description: Error parsing or validating the request body
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        409:
          description: Conflict if a particular `Rule's` limits are already reached
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "#/components/schemas/LimitReachedResponse"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
  /v1/limiter/counters/set:
    put:
      operationId: set Counters
      description: |
        Set a spcific `Counter` without checking or enforcinig any `Rules`. This API should only be used as
        part of a system onboarding experiance, or to clean up any processes which generate unique tags on
        startup and have crashed. In many systems such as these there is a single 'Repear' process to ensures
        the state of the world is eventually consistent and this api aims to make those operations easier.
      requestBody:
        required: true
        content:
          appplication/json:
            schema:
              $ref: "../common/components.yaml#/components/schemas/KeyValues"
      responses:
        200:
          description: Incremented the group of `KeyValues`
        400:
          description: Error parsing or validating the request body
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"
        500:
          description: Internal error that should be addressed by the service maintainer
          content:
            appplication/json:
              schema:
                type: object
                properties:
                  ApiError:
                    $ref: "../common/components.yaml#/components/schemas/ApiError"

components:
  schemas:
    # List rules that match the provided key values
    RuleMatch:
      type: object
      properties:
        allOf:
          $ref: "../common/components.yaml#/components/schemas/MatchKeyValues"
        OverridesToMatch:
          description: |
            Include overrides for the found rule.
            - "" - don't include any overrides
            - "all" - includes all overrides for the `Rule``
            - "match" - includes all overrides that also match the provided `KeyValues`
          type: string
          enum:
            - ""
            - "all"
            - "match"
        OverridesToQuery:
          description: |
            Overrides to query for on any Rules
          $ref: "../common/components.yaml#/components/schemas/AssociatedKeyValuesQuery"

    # create a new rule request
    RuleRequest:
      type: object
      required:
        - Name
        - GroupBy
        - Limit
      properties:
        Name:
          description: "Name of the rule to create"
          type: string
        GroupBy:
          description: |
            GroupBy defines the Keys for any `Counters.KeyValues` that make a unique group matching the `Rule`.
          type: array
          items:
            type: string
        Limit:
          description: |
            Max limit for any Key Value Group. If this is set to -1, then the value is treated a 'unlimited'
          type: integer
          format: int64

    # Uppdate requests
    UpdateRuleRequest:
      type: object
      required:
        - Limit
      properties:
        Limit:
          type: integer
          format: int64
          description: |
            default limit that all `Rules` match `Counters.KeyValues` against. If this is set to -1, then the value is treated a 'unlimited'

    UpdateOverrideRequest:
      type: object
      required:
        - Limit
      properties:
        Limit:
          type: integer
          format: int64
          description: |
            default limit that all `Oveerrides` match `Counters.KeyValues` against. If this is set to -1, then the value is treated a 'unlimited'

    # Find rule response
    RuleResponse:
      type: object
      properties:
        Name:
          type: string
        GroupBy:
          type: array
          items:
            type: string
        Limit:
          type: integer
          format: int64
        RuleOverrides:
          type: array
          items:
            type: object
            properties:
              KeyValues:
                $ref: "../common/components.yaml#/components/schemas/KeyValues"
              Limit:
                type: integer
                format: uint64

    ListRulesResponse:
      type: array
      items:
        $ref: "#/components/schemas/RuleResponse"

    # create a new rule request
    RuleOverride:
      type: object
      required:
        - Name
        - KeyValues
        - Limit
      properties:
        Name:
          description: "Name of the override rule to create"
          type: string
        KeyValues:
          description: |
            The `KeyValues` must at a minimum include the `Rule's` GroupBy Keys with a Value.
          $ref: "../common/components.yaml#/components/schemas/KeyValues"
        Limit:
          description: |
            Limit to match `Overrides.KeyValues` against. If this is set to -1, then the value is treated a 'unlimited'
          type: integer
          format: int64
    RuleOverrides:
      type: array
      items:
        $ref: "#/components/schemas/RuleOverride"

    # incremenet response if a rule has already been reached
    LimitReachedResponse:
      type: object
      properties:
        RuleName:
          type: string
        Override:
          description: if an override was used to determine the limits reached
          type: object
          properties:
            KeyValues:
              $ref: "../common/components.yaml#/components/schemas/KeyValues"
            Limit:
              type: integer
              format: int64

    # increment or decrement counters request
    Counter:
      type: object
      required:
        - KeyValues
        - Counters
      properties:
        KeyValues:
          $ref: "../common/components.yaml#/components/schemas/KeyValues"
        Counters:
          description: |
            1. On incrment, increase the counters for the associaated `KeyValues`.\
            2. On Decrement, decrease the counters for the associaated `KeyValues`.\
            3. On set, these are forcefully setting the counters for the associated `KeyValues`.

            When ever updating the counters, if the count is less than or equal to 0, the counters
            is removed service side
          type: integer

    Counters:
      type: array
      items:
        $ref: "#/components/schemas/Counter"
